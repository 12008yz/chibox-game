#!/usr/bin/env node
// ==== HTTPS + SOCKET.IO –°–¢–ê–†–¢–ï–† –î–õ–Ø EXPRESS ====

const fs = require('fs');
const http = require('http');
const path = require('path');
const socketIO = require('socket.io');
const app = require('../app');

// –ü–æ–ª—É—á–∞–µ–º –ø–æ—Ä—Ç
const port = normalizePort(process.env.PORT || '3000');
app.set('port', port);

// === –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø—É—Ç—å –∫ –∫–ª—é—á—É –∏ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—É ===
function getSSLOptions() {
  const certPath = process.env.SSL_CERT || path.join(__dirname, '../server.cert');
  const keyPath = process.env.SSL_KEY || path.join(__dirname, '../server.key');
  return {
    cert: fs.readFileSync(certPath),
    key: fs.readFileSync(keyPath),
  };
}
const sslOptions = getSSLOptions();

// === –°–æ–∑–¥–∞—ë–º HTTP —Å–µ—Ä–≤–µ—Ä (–≤—Ä–µ–º–µ–Ω–Ω–æ, –¥–ª—è —É–ø—Ä–æ—â–µ–Ω–∏—è —Ç—É–Ω–Ω–µ–ª–∏—Ä–æ–≤–∞–Ω–∏—è) ===
const server = http.createServer(app);

// === –ó–ê–©–ò–¢–ê –û–¢ DDoS: –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π –∏ —Ç–∞–π–º–∞—É—Ç—ã ===
server.maxConnections = 200; // –ú–∞–∫—Å–∏–º—É–º –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
server.timeout = 30000; // 30 —Å–µ–∫—É–Ω–¥ —Ç–∞–π–º–∞—É—Ç –¥–ª—è –∑–∞–ø—Ä–æ—Å–æ–≤ (–∑–∞—â–∏—Ç–∞ –æ—Ç Slowloris)
server.keepAliveTimeout = 5000; // 5 —Å–µ–∫—É–Ω–¥ keep-alive (–±—ã—Å—Ç—Ä–æ–µ –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤)
server.headersTimeout = 10000; // 10 —Å–µ–∫—É–Ω–¥ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ (–∑–∞—â–∏—Ç–∞ –æ—Ç slow headers attack)

console.log('üõ°Ô∏è  –ó–∞—â–∏—Ç–∞ –æ—Ç DDoS –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞:');
console.log(`   - –ú–∞–∫—Å. —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π: ${server.maxConnections}`);
console.log(`   - –¢–∞–π–º–∞—É—Ç –∑–∞–ø—Ä–æ—Å–∞: ${server.timeout}ms`);
console.log(`   - Keep-alive: ${server.keepAliveTimeout}ms`);
console.log(`   - –¢–∞–π–º–∞—É—Ç –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤: ${server.headersTimeout}ms`);

// === –ü–æ–¥–∫–ª—é—á–∞–µ–º socket.io ===
const io = socketIO(server, {
  cors: {
    origin: process.env.NODE_ENV === 'production'
      ? ['https://chibox-game.ru', 'https://www.chibox-game.ru', 'https://api.chibox-game.ru']
      : ['http://localhost:5173', 'http://localhost:3000', 'http://127.0.0.1:5173'],
    methods: ['GET', 'POST'],
    credentials: true
  },
  // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∑–∞—â–∏—Ç—ã –¥–ª—è Socket.IO
  maxHttpBufferSize: 1e6, // 1MB –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä —Å–æ–æ–±—â–µ–Ω–∏—è
  pingTimeout: 20000, // 20 —Å–µ–∫—É–Ω–¥ —Ç–∞–π–º–∞—É—Ç –¥–ª—è ping
  pingInterval: 25000, // 25 —Å–µ–∫—É–Ω–¥ –∏–Ω—Ç–µ—Ä–≤–∞–ª ping
  connectTimeout: 10000 // 10 —Å–µ–∫—É–Ω–¥ —Ç–∞–π–º–∞—É—Ç –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
});

// –£–ª—É—á—à–µ–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –ø–æ–¥—Å—á–µ—Ç–∞ –æ–Ω–ª–∞–π–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
const userSessions = new Map(); // –•—Ä–∞–Ω–∏—Ç –≤—Å–µ —Å–µ—Å—Å–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
const userConnections = new Map(); // –•—Ä–∞–Ω–∏—Ç –∞–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤—Å–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–Ω—ã–º –∫–ª–∏–µ–Ω—Ç–∞–º
function broadcastOnlineUsers() {
  const onlineUsers = userSessions.size;
  io.emit('onlineUsersUpdate', { count: onlineUsers });
  console.log(`–£–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –æ–Ω–ª–∞–π–Ω: ${onlineUsers}`);
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –∂–∏–≤–æ–≥–æ –ø–∞–¥–µ–Ω–∏—è –≤—Å–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–Ω—ã–º –∫–ª–∏–µ–Ω—Ç–∞–º
function broadcastLiveDrop(dropData) {
  io.emit('liveDrop', dropData);
  console.log(`Live Drop –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω: ${dropData.user.username} –ø–æ–ª—É—á–∏–ª ${dropData.item.name}`);
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
function sendNotificationToUser(userId, notification) {
  // –ù–∞—Ö–æ–¥–∏–º –≤—Å–µ —Å–æ–∫–µ—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  const userIdKey = `user_${userId}`;
  const connections = userConnections.get(userIdKey);

  if (connections && connections.size > 0) {
    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤—Å–µ–º –∞–∫—Ç–∏–≤–Ω—ã–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    connections.forEach(socketId => {
      const socket = io.sockets.sockets.get(socketId);
      if (socket) {
        socket.emit('notification', notification);
        console.log(`–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é ${userId} (socket ${socketId}): ${notification.title}`);
      }
    });
  } else {
    console.log(`–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${userId} –Ω–µ –æ–Ω–ª–∞–π–Ω, —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –±—É–¥–µ—Ç –¥–æ—Å—Ç–∞–≤–ª–µ–Ω–æ –ø—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–º –≤—Ö–æ–¥–µ`);
  }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —É–Ω–∏–∫–∞–ª—å–Ω–æ–≥–æ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
function getUserId(socket) {
  // –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å user ID –∏–∑ —Å–µ—Å—Å–∏–∏
  const session = socket.request.session;
  if (session && session.user && session.user.id) {
    return `user_${session.user.id}`;
  }

  // –ï—Å–ª–∏ –Ω–µ—Ç –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –∏—Å–ø–æ–ª—å–∑—É–µ–º IP + User-Agent
  const ip = socket.handshake.address;
  const userAgent = socket.handshake.headers['user-agent'] || 'unknown';
  const fingerprint = require('crypto').createHash('md5').update(ip + userAgent).digest('hex');
  return `guest_${fingerprint}`;
}

io.on('connection', (socket) => {
  const userId = getUserId(socket);

  // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –ø–µ—Ä–≤–æ–µ –ª–∏ —ç—Ç–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  let isNewUser = false;
  if (!userSessions.has(userId)) {
    userSessions.set(userId, {
      id: userId,
      firstConnectedAt: new Date(),
      lastActivity: new Date()
    });
    isNewUser = true;
  } else {
    // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
    userSessions.get(userId).lastActivity = new Date();
  }

  // –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –≤ —Å–ø–∏—Å–æ–∫ –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  if (!userConnections.has(userId)) {
    userConnections.set(userId, new Set());
  }
  userConnections.get(userId).add(socket.id);

  if (isNewUser) {
    console.log(`Socket.IO: –ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–¥–∫–ª—é—á–∏–ª—Å—è (${userId}). –£–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –æ–Ω–ª–∞–π–Ω: ${userSessions.size}`);
  } else {
    console.log(`Socket.IO: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∏–ª—Å—è (${userId}). –°–æ–µ–¥–∏–Ω–µ–Ω–∏–π: ${userConnections.get(userId).size}`);
  }

  // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–æ–≤–æ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
  socket.emit('hello', { message: '–ü—Ä–∏–≤–µ—Ç —á–µ—Ä–µ–∑ WebSocket!' });

  // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–µ–∫—É—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
  if (isNewUser) {
    broadcastOnlineUsers();
  } else {
    // –î–ª—è –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ —Ç–µ–∫—É—â–µ–º—É —Å–æ–∫–µ—Ç—É
    socket.emit('onlineUsersUpdate', { count: userSessions.size });
  }

  // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–∫–ª—é—á–µ–Ω–∏—è
  socket.on('disconnect', (reason) => {
    const connections = userConnections.get(userId);
    if (connections) {
      connections.delete(socket.id);

      // –ï—Å–ª–∏ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –±–æ–ª—å—à–µ –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π
      if (connections.size === 0) {
        userConnections.delete(userId);
        userSessions.delete(userId);
        console.log(`Socket.IO: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª–Ω–æ—Å—Ç—å—é –æ—Ç–∫–ª—é—á–∏–ª—Å—è (${userId}, ${reason}). –£–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –æ–Ω–ª–∞–π–Ω: ${userSessions.size}`);
        broadcastOnlineUsers();
      } else {
        console.log(`Socket.IO: –û–¥–Ω–æ –∏–∑ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∑–∞–∫—Ä—ã—Ç–æ (${userId}, ${reason}). –ê–∫—Ç–∏–≤–Ω—ã—Ö —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π: ${connections.size}`);
      }
    }
  });

  // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
  socket.on('error', (error) => {
    console.error('Socket.IO error:', error);
  });
});

// –û—á–∏—Å—Ç–∫–∞ –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç
setInterval(() => {
  const now = new Date();
  const fiveMinutesAgo = new Date(now.getTime() - 5 * 60 * 1000);

  let cleanedUsers = 0;
  for (const [userId, userData] of userSessions.entries()) {
    if (userData.lastActivity < fiveMinutesAgo) {
      userSessions.delete(userId);
      userConnections.delete(userId);
      cleanedUsers++;
    }
  }

  if (cleanedUsers > 0) {
    console.log(`–û—á–∏—â–µ–Ω–æ –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: ${cleanedUsers}. –û–Ω–ª–∞–π–Ω: ${userSessions.size}`);
    broadcastOnlineUsers();
  }
}, 5 * 60 * 1000);

server.listen(port, '0.0.0.0');
server.on('error', onError);
server.on('listening', onListening);

// === –°–ª—É–∂–µ–±–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ ===
function normalizePort(val) {
  const port = parseInt(val, 10);
  if (isNaN(port)) return val;
  if (port >= 0) return port;
  return false;
}

function onError(error) {
  if (error.syscall !== 'listen') throw error;
  const bind = typeof port === 'string' ? 'Pipe ' + port : 'Port ' + port;
  switch (error.code) {
    case 'EACCES':
      console.error(bind + ' —Ç—Ä–µ–±—É–µ—Ç –ø–æ–≤—ã—à–µ–Ω–Ω—ã—Ö –ø—Ä–∏–≤–∏–ª–µ–≥–∏–π');
      process.exit(1);
      break;
    case 'EADDRINUSE':
      console.error(bind + ' —É–∂–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è');
      process.exit(1);
      break;
    default:
      throw error;
  }
}

function onListening() {
  const addr = server.address();
  const bind = typeof addr === 'string' ? 'pipe ' + addr : '–ø–æ—Ä—Ç ' + addr.port;
  console.log('HTTP —Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω –Ω–∞ ' + bind);
  console.log('Socket.IO –≥–æ—Ç–æ–≤.');
  console.log('–î–ª—è –±–æ–µ–≤–æ–≥–æ ssl –ø—Ä–æ—Å—Ç–æ –ø–æ–º–µ–Ω—è–π —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã/–ø—É—Ç–∏ —á–µ—Ä–µ–∑ ENV –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ (SSL_KEY, SSL_CERT) ‚Äî –∫–æ–¥ –º–µ–Ω—è—Ç—å –Ω–µ –ø–æ—Ç—Ä–µ–±—É–µ—Ç—Å—è!');
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º LiveDrop —Å–µ—Ä–≤–∏—Å
const { initLiveDropService } = require('../services/liveDropService');
initLiveDropService(broadcastLiveDrop);

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å–∏—Å—Ç–µ–º—É —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
const { initNotificationSender } = require('../utils/notificationHelper');
initNotificationSender(sendNotificationToUser);

// –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º io –∏ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ –¥—Ä—É–≥–∏—Ö –º–æ–¥—É–ª—è—Ö
