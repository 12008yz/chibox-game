# Интеграция с Альфа-Банком (Альфа-Касса)

## Описание

Интеграция с Альфа-Банком для приема платежей через интернет-эквайринг. Поддерживает как динамические платежи через API, так и статические платежи через QR-коды СБП.

## Проблемы и решения

### Проблема 1: Ошибка "Доступ запрещён" (errorCode: '5')

**Причина:**

- ❌ **Используете пароль от личного кабинета вместо API пароля** (самая частая причина!)
- Неверные учетные данные API (логин/пароль)
- Первичный пароль требует смены
- Неправильный URL API

**Решение:**

1. **Проверьте, что используете ПРАВИЛЬНЫЕ учетные данные:**

   - `ALFABANK_API_LOGIN` - это НЕ логин от личного кабинета, а отдельный API логин (обычно с суффиксом `-api`)
   - `ALFABANK_API_PASSWORD` - это НЕ пароль от личного кабинета, а отдельный API пароль
   - Если используете пароль от личного кабинета - это ошибка! Нужен отдельный API пароль.

2. **Где взять API пароль:**

   - Обратитесь в техническую поддержку Альфа-Банка
   - Скажите, что нужны учетные данные для API интернет-эквайринга
   - Они предоставят логин (с суффиксом `-api`) и временный пароль

3. **После получения API пароля:**

   - Авторизуйтесь в личном кабинете Альфа-Банка под логином с суффиксом `-api`
   - Смените временный пароль на постоянный
   - Обновите `ALFABANK_API_LOGIN` и `ALFABANK_API_PASSWORD` в переменных окружения
   - Перезапустите приложение

4. **Проверьте права доступа:**
   - Убедитесь, что ваш API-пользователь имеет права на регистрацию платежей
   - При необходимости обратитесь в техническую поддержку Альфа-Банка

### Проблема 2: Checksum не проходит проверку

**Причина:**

- Альфа-Банк может использовать как MD5, так и SHA256 для подписи
- Неправильный `ALFABANK_CALLBACK_TOKEN`

**Решение:**

1. Проверьте переменную окружения:

   - `ALFABANK_CALLBACK_TOKEN` - токен для проверки подписи callback'ов
   - Токен можно найти в личном кабинете Альфа-Банка в настройках уведомлений

2. Код автоматически определяет алгоритм по длине checksum:

   - MD5 = 32 символа
   - SHA256 = 64 символа

3. Код пробует несколько вариантов формул:

   - `SHA256(orderNumber + status + token)` - стандартная формула
   - `SHA256(status + orderNumber + token)` - альтернативный порядок
   - `SHA256(mdOrder + status + token)` - с использованием mdOrder (для динамических callback'ов)
   - Аналогично для MD5

4. Если checksum все равно не проходит:
   - Проверьте, что токен указан правильно (без пробелов, в правильном регистре)
   - Убедитесь, что в личном кабинете Альфа-Банка указан правильный алгоритм подписи
   - Проверьте логи - там будет показано, какие формулы пробовались и какой токен используется
   - **ВАЖНО:** Даже если checksum не проходит, платеж все равно обрабатывается (платеж может быть валидным, но токен настроен неправильно)

### Проблема 3: Вебхуки не приходят

**Причина:**

- Неправильно настроен callback URL
- Сервер недоступен из внешней сети
- Блокировка запросов от Альфа-Банка

**Решение:**

1. Для динамических платежей через API:

   - Callback URL автоматически передается в параметре `callbackUrl` при регистрации платежа
   - URL должен быть доступен из интернета: `https://your-domain.com/api/payments/alfabank/callback`

2. Проверьте настройки в личном кабинете Альфа-Банка:

   - URL для уведомлений должен совпадать с вашим callback URL
   - Убедитесь, что уведомления включены

3. Проверьте доступность сервера:

   - Убедитесь, что сервер доступен из интернета
   - Проверьте, что нет блокировок по IP в firewall
   - Проверьте логи сервера на наличие входящих запросов от Альфа-Банка

4. Проверьте SSL-сертификат:
   - Альфа-Банк требует HTTPS для callback URL
   - Сертификат должен быть валидным и не истекшим

### Проблема 4: Платежи остаются в статусе "pending"

**Причина:**

- Вебхук со статусом 2 (успешная оплата) не приходит
- Неправильное сопоставление orderNumber и mdOrder

**Решение:**

1. Проверьте логи:

   - Ищите записи с `ALFABANK CALLBACK RECEIVED`
   - Проверьте, какой статус приходит в callback'ах
   - Статус 1 = холд (ожидание), статус 2 = успешная оплата

2. Проверьте сопоставление платежей:

   - Код автоматически ищет платеж по нескольким критериям:
     - mdOrder (внутренний номер Альфа-Банка)
     - invoice_number (наш номер заказа)
     - alfabankOrderNumber (номер заказа от Альфа-Банка)
   - При статусе 1 сохраняются все данные для последующего сопоставления

3. Если платеж не находится:
   - Проверьте логи на наличие предупреждений `Payment not found`
   - Убедитесь, что платеж создан в БД перед отправкой на оплату

## Нужен ли пароль API?

**ДА, нужен ОТДЕЛЬНЫЙ пароль API!** Это НЕ пароль от входа в личный кабинет.

### Где взять пароль API?

1. **При подключении интернет-эквайринга:**

   - Альфа-Банк предоставляет отдельные учетные данные для API
   - Логин обычно имеет суффикс `-api` (например, `your_merchant-api`)
   - Пароль API отличается от пароля личного кабинета

2. **Если не получили при подключении:**

   - Обратитесь в техническую поддержку Альфа-Банка
   - Скажите, что нужны учетные данные для API интернет-эквайринга
   - Они предоставят логин и временный пароль

3. **После получения:**
   - Войдите в личный кабинет под логином с суффиксом `-api`
   - Смените временный пароль на постоянный
   - Используйте эти данные в переменных окружения

### Можно ли работать БЕЗ API пароля?

**ДА, можно!** Но с ограничениями:

- ✅ **Со статическими платежами (QR-коды):** Работает без API
- ❌ **Без автоматических вебхуков:** Нужно проверять статус вручную или через success URL
- ❌ **Без динамических платежей:** Нельзя создавать платежи через API

**Рекомендация:** Получите API пароль для полноценной работы с автоматическими вебхуками.

## Настройка переменных окружения

Добавьте следующие переменные в ваш `.env` файл:

```env
# === АЛЬФА-БАНК (API для динамических платежей) ===
# Логин для API (обычно с суффиксом -api, например: your_merchant-api)
# ВАЖНО: Это НЕ логин от личного кабинета, а отдельный API логин!
ALFABANK_API_LOGIN=your_merchant-api

# Пароль для API (обязательно смените первичный пароль!)
# ВАЖНО: Это НЕ пароль от личного кабинета, а отдельный API пароль!
ALFABANK_API_PASSWORD=your_api_password

# URL API (по умолчанию: https://pay.alfabank.ru/payment/rest)
ALFABANK_PAYMENT_GATEWAY_URL=https://pay.alfabank.ru/payment/rest

# Токен для проверки подписи callback'ов (находится в личном кабинете)
ALFABANK_CALLBACK_TOKEN=your_callback_token

# === АЛЬФА-БАНК (Статические платежи) ===
# Статический URL для платежей (если не используется API)
ALFABANK_PAYMENT_URL=https://payment.alfabank.ru/sc/your_merchant_id

# QR-код для СБП (базовая ссылка)
ALFABANK_QR_URL=https://qr.nspk.ru/your_qr_code?type=01&bank=100000000008&crc=XXXX

# QR-коды для подписок (опционально)
ALFABANK_QR_SUBSCRIPTION_TIER_1=https://qr.nspk.ru/...
ALFABANK_QR_SUBSCRIPTION_TIER_2=https://qr.nspk.ru/...
ALFABANK_QR_SUBSCRIPTION_TIER_3=https://qr.nspk.ru/...

# URL бэкенда (для callback'ов)
BACKEND_URL=https://your-domain.com
```

## Статусы платежей

Альфа-Банк использует следующие статусы:

- **0** - заказ зарегистрирован, но не оплачен
- **1** - предавторизованная сумма захолдирована (холд)
- **2** - проведена полная авторизация суммы заказа (успешная оплата) ✅
- **3** - авторизация отменена
- **4** - по транзакции была проведена операция возврата
- **5** - инициирована авторизация через ACS банка-эмитента
- **6** - авторизация отклонена

## Проверка подписи (checksum)

Код автоматически определяет алгоритм подписи по длине checksum:

- **MD5** - 32 символа (hex)
- **SHA256** - 64 символа (hex)

Код пробует несколько вариантов формул (в порядке приоритета):

1. **Стандартная формула:**

   ```
   MD5: MD5(orderNumber + status + callbackToken)
   SHA256: SHA256(orderNumber + status + callbackToken)
   ```

2. **Альтернативный порядок параметров:**

   ```
   SHA256: SHA256(status + orderNumber + callbackToken)
   ```

3. **С использованием mdOrder (для динамических callback'ов):**
   ```
   SHA256: SHA256(mdOrder + status + callbackToken)
   MD5: MD5(mdOrder + status + callbackToken)
   ```

**ВАЖНО:** Если checksum не проходит проверку, платеж все равно обрабатывается. Это сделано для того, чтобы не блокировать валидные платежи из-за неправильной настройки токена. Проверьте логи для отладки.

## Сопоставление платежей в callback'ах

При обработке callback'ов код ищет платеж в следующем порядке:

1. По `mdOrder` в `payment_id`
2. По `mdOrder` в `payment_details.mdOrder`
3. По `orderNumber` как `invoice_number` (наш номер заказа)
4. По `orderNumber` в `payment_details.alfabankOrderNumber` (номер от Альфа-Банка)
5. По `orderId` в `payment_id`
6. По `orderNumber` как `payment_id` (для статических платежей)

**ВАЖНО:** Альфа-Банк может отправлять свой внутренний `orderNumber`, который отличается от нашего `invoice_number`. Поэтому при статусе 1 сохраняются все данные для последующего сопоставления.

## Динамические vs Статические платежи

### Динамические платежи (через API)

**Преимущества:**

- Автоматическое создание платежных ссылок
- Получение вебхуков о статусе платежа
- Возможность проверки статуса через API

**Требования:**

- Настроенные `ALFABANK_API_LOGIN` и `ALFABANK_API_PASSWORD`
- Доступный из интернета callback URL

### Статические платежи (через QR-коды)

**Преимущества:**

- Не требуют API credentials
- Работают через СБП (Система быстрых платежей)
- Простая настройка

**Недостатки:**

- Нет автоматических вебхуков (только через returnUrl)
- Требуется ручная проверка статуса платежей

## Отладка

### Включение подробного логирования

В логах вы увидите:

- Все входящие callback'ы с полными параметрами
- Результаты проверки checksum
- Процесс поиска платежа в БД
- Обновление статусов платежей

### Проверка статуса платежа вручную

Используйте скрипт для проверки статуса:

```bash
node scripts/check-alfabank-payment.js <invoice_number>
```

### Ручное завершение платежа

Если платеж не обработался автоматически:

```bash
node scripts/manual-complete-alfabank.js <invoice_number> --confirm
```

## Полезные ссылки

- [Документация API Альфа-Банка](https://alfabank.ru/sme/payservice/internet-acquiring/docs/connection-options/api/)
- [Личный кабинет Альфа-Банка](https://pay.alfabank.ru/)

## Проблема: Баланс не обновляется после оплаты

**Причина:**

- При использовании статических платежей (без API) вебхуки могут не приходить
- API credentials не работают (ошибка "Доступ запрещён"), поэтому динамические платежи не создаются

**Решение:**

1. **Исправьте API credentials** (рекомендуется):

   - Проверьте `ALFABANK_API_LOGIN` и `ALFABANK_API_PASSWORD`
   - Смените первичный пароль в личном кабинете Альфа-Банка
   - После исправления динамические платежи будут работать с автоматическими вебхуками

2. **Проверка статуса через success URL** (временное решение):

   - При переходе пользователя на success URL код автоматически проверяет статус через API
   - Если платеж оплачен (статус 2), баланс обновляется автоматически
   - Это работает только если API credentials для `getOrderStatus` работают

3. **Ручная проверка статуса**:

   ```bash
   node scripts/check-alfabank-payment.js <invoice_number>
   ```

4. **Ручное завершение платежа**:
   ```bash
   node scripts/manual-complete-alfabank.js <invoice_number> --confirm
   ```

**ВАЖНО:** Для полноценной работы необходимо исправить API credentials, чтобы динамические платежи работали с автоматическими вебхуками.

## Поддержка

При возникновении проблем:

1. Проверьте логи сервера на наличие ошибок
2. Убедитесь, что все переменные окружения настроены правильно
3. Проверьте настройки в личном кабинете Альфа-Банка
4. Обратитесь в техническую поддержку Альфа-Банка с логами и описанием проблемы
