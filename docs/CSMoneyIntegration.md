# Интеграция с CS.Money

Этот документ описывает процесс настройки и использования интеграции с платформой CS.Money для импорта предметов и автоматического вывода предметов пользователям.

## Содержание

1. [Настройка конфигурации](#настройка-конфигурации)
2. [Импорт предметов](#импорт-предметов)
3. [Функциональность автоматического вывода](#функциональность-автоматического-вывода)
4. [Мониторинг и обслуживание](#мониторинг-и-обслуживание)
5. [Решение проблем](#решение-проблем)
6. [Руководство по продакшн-эксплуатации](#руководство-по-продакшн-эксплуатации)

## Настройка конфигурации

Для работы с CS.Money необходимо настроить конфигурацию с авторизационными данными:

1. Войдите в свой аккаунт на [CS.Money](https://cs.money/ru/market/buy/)
2. Откройте инструменты разработчика (F12 или Ctrl+Shift+I)
3. Перейдите в раздел Application > Cookies > cs.money
4. Скопируйте нужные cookies для авторизации
5. Запустите скрипт настройки:

```bash
node scripts/setup-csmoney-config.js
```

Скрипт запросит необходимые данные и сохранит их в файл `config/csmoney_config.json`.

## Импорт предметов

Для импорта предметов с CS.Money в базу данных используется скрипт:

```bash
node scripts/import-csmoney-items.js
```

Скрипт последовательно выполняет:
- Получение списка предметов с CS.Money (по страницам)
- Обработку и нормализацию данных
- Сохранение или обновление предметов в базе данных

### Параметры импорта

По умолчанию скрипт импортирует все доступные предметы с лимитом 60 предметов на запрос. Это ограничение API CS.Money.

## Функциональность автоматического вывода

Интеграция позволяет автоматически покупать и выводить предметы пользователям при обработке заявок на вывод:

1. При получении заявки на вывод предмета система проверяет его наличие в инвентаре
2. Если предмет отсутствует, система ищет его на маркетплейсах с приоритетом CS.Money > LIS > BUFF
3. Система автоматически выбирает наиболее выгодное предложение и совершает покупку
4. После успешной покупки система отправляет предмет пользователю через Steam трейд

### Приоритет при покупке предметов

Система использует следующий порядок предпочтения площадок:
1. CS.Money
2. LIS-Skins
3. BUFF

## Мониторинг и обслуживание

### Логи

Все операции с CS.Money записываются в лог-файл `csmoney-service.log`. Для импорта используется отдельный лог `import-csmoney-items.log`.

### Проверка конфигурации

Для проверки правильности конфигурации можно использовать скрипт:

```bash
node scripts/test-csmoney-config.js
```

### Обновление cookies

Рекомендуется периодически обновлять cookies для авторизации на CS.Money (примерно раз в неделю), используя скрипт `setup-csmoney-config.js`.

## Решение проблем

### Ошибка авторизации

Если возникают проблемы с авторизацией:
1. Проверьте, что cookies актуальны и правильно скопированы
2. Убедитесь, что аккаунт CS.Money не имеет ограничений
3. Обновите cookies с помощью скрипта `setup-csmoney-config.js`

### Ошибки при импорте

Если возникают ошибки при импорте:
1. Проверьте соединение с API CS.Money
2. Убедитесь, что лимиты запросов не превышены
3. Просмотрите лог-файл `import-csmoney-items.log` для детальной информации

### Ошибки при покупке предметов

При проблемах с покупкой предметов:
1. Проверьте баланс на CS.Money
2. Убедитесь, что предмет доступен для покупки
3. Проверьте, что настройки трейда в аккаунте правильны
4. Просмотрите лог-файл `csmoney-service.log` для детальной информации

## Руководство по продакшн-эксплуатации

Это руководство описывает полный процесс настройки и поддержки системы интеграции с CS.Money в продакшн-среде.

### 1. Начальная настройка перед запуском

#### Настройка конфигурации CS.Money
1. Настройте актуальные cookies для CS.Money:
   ```bash
   node scripts/setup-csmoney-config.js
   ```
   В интерактивном режиме введите cookies из браузера (см. раздел [Настройка конфигурации](#настройка-конфигурации) выше).

2. Проверьте актуальность cookies и доступ к API:
   ```bash
   node scripts/test-csmoney-config.js
   ```
   Убедитесь, что тест показывает успешную авторизацию и доступ к API.

#### Настройка Steam бота
1. Проверьте, что файл `config/steam_bot.js` содержит корректные учетные данные бота.
2. Запустите тест бота для проверки авторизации и доступа к инвентарю:
   ```bash
   node scripts/test-steam-bot.js --full
   ```
   Убедитесь, что бот может авторизоваться и получить доступ к инвентарю.

### 2. Регулярное обновление данных

#### Импорт предметов
Импорт предметов необходимо выполнять регулярно для поддержания актуальности данных:

1. Запустите импорт вручную или через планировщик:
   ```bash
   node scripts/import-csmoney-items.js
   ```

2. Рекомендуемая частота импорта - раз в сутки, предпочтительно в период низкой нагрузки на сервер.

### 3. Настройка автоматической обработки выводов

Для обработки запросов на вывод предметов настройте регулярный запуск обработчика:

#### Использование PM2 (рекомендуется)

1. Установите PM2, если еще не установлен:
   ```bash
   npm install pm2 -g
   ```

2. Настройте PM2 для запуска обработчика выводов:
   ```bash
   pm2 start scripts/process-withdrawals.js --name "withdrawal-processor" --cron "*/5 * * * *"
   ```
   Это настроит запуск обработчика каждые 5 минут.

3. Настройте PM2 для импорта предметов:
   ```bash
   pm2 start scripts/import-csmoney-items.js --name "csmoney-importer" --cron "0 4 * * *"
   ```
   Это настроит запуск импорта в 4 часа утра каждый день.

4. Сохраните настройки PM2 для автозагрузки при перезапуске сервера:
   ```bash
   pm2 save
   pm2 startup
   ```
   Выполните команду, которую выдаст PM2 после `pm2 startup`.

#### Альтернативный вариант: системный CRON

Если вы предпочитаете использовать системный CRON:

1. Откройте crontab для редактирования:
   ```bash
   crontab -e
   ```

2. Добавьте следующие строки:
   ```
   # Обработка заявок на вывод (каждые 5 минут)
   */5 * * * * cd /path/to/your/project && /usr/bin/node scripts/process-withdrawals.js >> /path/to/your/project/logs/withdrawal-processor.log 2>&1

   # Импорт предметов с CS.Money (каждый день в 4:00)
   0 4 * * * cd /path/to/your/project && /usr/bin/node scripts/import-csmoney-items.js >> /path/to/your/project/logs/csmoney-importer.log 2>&1
   ```
   Замените `/path/to/your/project` на реальный путь к вашему проекту.

### 4. Запуск основного API сервера

API сервер должен работать постоянно для обработки запросов пользователей:

```bash
pm2 start bin/www --name "chibox-api-server"
```

### 5. Расширенный мониторинг и обслуживание

#### Мониторинг логов
Регулярно проверяйте логи для выявления проблем:

1. Логи импорта предметов:
   ```bash
   tail -f import-csmoney-items.log
   ```

2. Логи обработки выводов:
   ```bash
   tail -f withdrawal-service.log
   ```

3. Логи Steam бота:
   ```bash
   tail -f steam-bot.log
   ```

#### Обновление cookies CS.Money
Cookies CS.Money имеют ограниченный срок действия (2-3 недели). Рекомендуется обновлять их еженедельно:

```bash
node scripts/setup-csmoney-config.js
```

#### Регулярная проверка системы
Используйте скрипт для проверки всех сервисов:

```bash
node scripts/test-all-services.js
```

### 6. Диагностика и устранение проблем в продакшене

#### Если CS.Money недоступен или выдает ошибки
- Проверьте актуальность cookies: `node scripts/test-csmoney-config.js`
- Обновите cookies: `node scripts/setup-csmoney-config.js`
- Проверьте, не изменилось ли API CS.Money: `node scripts/test-updated-csmoney-service.js`

#### Если Steam бот не работает
- Проверьте, не изменился ли пароль или другие данные
- Убедитесь, что Steam Guard настроен корректно
- Проверьте работоспособность: `node scripts/test-steam-bot.js --full`

#### Если заявки на вывод зависают в статусе "pending"
- Проверьте логи: `withdrawal-service.log`
- Запустите обработку вручную: `node scripts/process-withdrawals.js`
- Проверьте наличие достаточного баланса на CS.Money

#### Если предметы не доставляются пользователям
- Проверьте статус трейд-предложений в аккаунте бота
- Убедитесь, что trade URL пользователя корректен
- Проверьте, нет ли ограничений на трейды в аккаунте бота

### 7. Безопасность и оптимизация в продакшене

#### Рекомендации по безопасности
1. **Баланс CS.Money** - Держите на балансе только необходимую сумму
2. **Учетные данные** - Рекомендуется перенести чувствительные данные в переменные окружения
3. **Резервное копирование** - Регулярно делайте бэкап базы данных
4. **Мониторинг** - Настройте оповещения о критических ошибках

#### Оптимизация производительности
1. **Пакетная обработка** - Процессор выводов работает с группами заявок
2. **Кэширование** - Используется для часто запрашиваемых данных
3. **Очередь** - Заявки обрабатываются по приоритету

### 8. Обзор ключевых компонентов системы

Понимание взаимодействия компонентов поможет при диагностике проблем:

1. **`csmoneyService.js`** - Взаимодействие с CS.Money (авторизация, поиск, покупка)
2. **`steamBotService.js`** - Управление Steam ботом (авторизация, отправка трейдов)
3. **`withdrawalService.js`** - Координация процесса вывода (основная бизнес-логика)
4. **`import-csmoney-items.js`** - Скрипт импорта предметов
5. **`process-withdrawals.js`** - Скрипт обработки заявок на вывод

---

При возникновении вопросов или проблем обращайтесь к администратору системы.
