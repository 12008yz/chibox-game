# Пример для server {} с server_name streamer.chibox-game.ru
# Вставьте этот location ВЫШЕ location / (чтобы имел приоритет).
#
# Когда пользователь открывает https://streamer.chibox-game.ru/0E4B8BB4,
# nginx сразу проксирует на бэкенд — учёт перехода и редирект без JavaScript.

location ~ ^/([A-Za-z0-9_-]{4,64})$ {
    rewrite ^/(.*)$ /api/v1/referral/redirect/$1 break;
    proxy_pass http://127.0.0.1:3000;   # порт вашего Node (chibox-main)
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
}

# Остальные запросы (/, /profile, /auth, статика) — как обычно, в location / { ... }
